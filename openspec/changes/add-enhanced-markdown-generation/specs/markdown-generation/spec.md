# Spec Delta: Enhanced Markdown Generation

## ADDED Requirements

### Requirement: content_list.json Loading

The system SHALL load and parse content_list.json files generated by MinerU.

#### Scenario: Successful loading

- **WHEN** a valid content_list.json file path is provided
- **THEN** the system SHALL load and parse the JSON
- **AND** it SHALL return a list of content blocks
- **AND** each block SHALL contain type, content, and metadata fields

#### Scenario: Missing file

- **WHEN** the content_list.json file does not exist
- **THEN** the system SHALL raise a clear error
- **AND** the error message SHALL include the file path

#### Scenario: Invalid JSON

- **WHEN** the file contains invalid JSON
- **THEN** the system SHALL raise a clear error
- **AND** it SHALL log the parsing error details

### Requirement: Heading Hierarchy Mapping

The system SHALL map text_level values from content_list.json to Markdown heading levels.

#### Scenario: Standard heading levels

- **WHEN** a text block has text_level=1
- **THEN** it SHALL be converted to `# Heading`
- **WHEN** text_level=2
- **THEN** it SHALL be converted to `## Heading`
- **WHEN** text_level=3
- **THEN** it SHALL be converted to `### Heading`
- **AND** this pattern SHALL continue through level 6

#### Scenario: Out-of-range levels

- **WHEN** text_level is less than 1
- **THEN** it SHALL be treated as level 1 (# heading)
- **WHEN** text_level is greater than 6
- **THEN** it SHALL be capped at level 6 (######)

#### Scenario: Text without level

- **WHEN** a text block has no text_level or text_level=0
- **THEN** it SHALL be rendered as a paragraph (no heading markers)

### Requirement: Table Preservation

The system SHALL preserve table structure by keeping tables as HTML blocks.

#### Scenario: Table with HTML field

- **WHEN** a block has type="table" and contains an "html" field
- **THEN** the HTML SHALL be included in the Markdown as-is
- **AND** the HTML SHALL be on its own line(s)

#### Scenario: Table with content field

- **WHEN** a block has type="table" and contains a "content" field but no "html"
- **THEN** the content field SHALL be used as the table representation

#### Scenario: Empty table

- **WHEN** a table block has neither html nor content
- **THEN** it SHALL be skipped with a warning log

### Requirement: Equation Formatting

The system SHALL format equations using LaTeX notation with display math delimiters.

#### Scenario: Equation with LaTeX

- **WHEN** a block has type="equation"
- **THEN** the system SHALL extract LaTeX from "content" or "latex" field
- **AND** it SHALL wrap the LaTeX in `$$\n...\n$$` for display math
- **AND** it SHALL avoid double-wrapping if already wrapped

#### Scenario: Inline vs display math

- **WHEN** an equation is marked for display
- **THEN** it SHALL use `$$` delimiters (block-level)
- **AND** the equation SHALL be on its own line(s)

### Requirement: Image and Caption Handling

The system SHALL include images with their captions in the Markdown output.

#### Scenario: Image with caption

- **WHEN** an image block contains img_path and img_caption
- **THEN** the system SHALL generate `![caption](path)`
- **AND** it SHALL include the caption as italic text below: `*caption*`

#### Scenario: Image without caption

- **WHEN** an image block has img_path but no caption
- **THEN** the system SHALL generate `![](path)`

#### Scenario: Caption as list

- **WHEN** img_caption is a list of strings
- **THEN** the system SHALL join them with spaces
- **AND** it SHALL use the joined string as the caption

#### Scenario: Missing image path

- **WHEN** an image block has no img_path
- **THEN** it SHALL be skipped with a warning log

### Requirement: Content Type Handling

The system SHALL handle various content block types from MinerU output.

#### Scenario: Code blocks

- **WHEN** a block has type="code"
- **THEN** the system SHALL include the content field
- **AND** it MAY wrap it in code fence markers (```)

#### Scenario: List blocks

- **WHEN** a block has type="list"
- **THEN** the system SHALL include the content as-is

#### Scenario: Unknown types

- **WHEN** a block has an unrecognized type
- **THEN** the system SHALL attempt to extract "content" field
- **AND** it SHALL log a warning about the unknown type

### Requirement: Blank Line Normalization

The system SHALL normalize excessive blank lines in the output.

#### Scenario: Multiple consecutive blank lines

- **WHEN** the Markdown contains 3 or more consecutive blank lines
- **THEN** the system SHALL reduce them to exactly 2 blank lines

#### Scenario: Trailing whitespace

- **WHEN** the Markdown has trailing whitespace
- **THEN** the system SHALL trim it
- **AND** it SHALL ensure exactly one newline at end of file

### Requirement: Structured Markdown File Generation

The system SHALL generate .structured.md files from content_list.json.

#### Scenario: Output filename generation

- **WHEN** processing `/path/output/doc_content_list.json`
- **THEN** the output SHALL be `/path/output/doc.structured.md`

#### Scenario: File writing

- **WHEN** the Markdown is generated
- **THEN** it SHALL be written with UTF-8 encoding
- **AND** it SHALL be saved to the same directory as the JSON
- **AND** the system SHALL log the output path

#### Scenario: Overwrite handling

- **WHEN** a .structured.md file already exists
- **THEN** it SHALL be overwritten without warning

### Requirement: Batch Integration

The system SHALL integrate post-processing into the batch workflow.

#### Scenario: Automatic post-processing

- **WHEN** a PDF is processed by the batch system
- **THEN** post-processing SHALL run automatically after MinerU completes
- **AND** the .structured.md SHALL be saved to MDFilesCreated

#### Scenario: Post-processing failure

- **WHEN** post-processing fails for a PDF
- **THEN** the original Markdown SHALL still be available
- **AND** the error SHALL be logged
- **AND** the batch SHALL continue processing other PDFs

### Requirement: Standalone CLI

The system SHALL provide a standalone script for post-processing existing outputs.

#### Scenario: Process a directory

- **WHEN** `python scripts/postprocess_markdown.py /path/to/outputs` is run
- **THEN** the system SHALL find all *_content_list.json files recursively
- **AND** it SHALL process each one
- **AND** it SHALL display progress

#### Scenario: No JSON files found

- **WHEN** the target directory contains no content_list.json files
- **THEN** the system SHALL display a message
- **AND** it SHALL exit without error

#### Scenario: Summary output

- **WHEN** processing completes
- **THEN** the system SHALL display total files processed
- **AND** it SHALL show any errors encountered
